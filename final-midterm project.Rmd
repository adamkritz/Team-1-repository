---
title: "Team 1 Mid-term Project"
author: "Team 1 (Names: Adam Kritz; Huang He..."
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---



```{r init, include=F}
# The package "ezids" (EZ Intro to Data Science) includes a lot of the helper functions we developed for the course. 
# Some of the frequently used functions are loadPkg(), xkabledply(), xkablesummary(), uzscale(), etc.
library(ezids)
```

# Midterm Project

## Importing the Data

```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

```{r read the dataset}
diamonds = data.frame(read.csv("diamonds.csv"))
summary(diamonds)
str(diamonds)
diamonds$color = factor(diamonds$color, order=T, levels = c('D', 'E', 'F', 'G', 'H', 'I', 'J'))
diamonds$clarity = factor(diamonds$clarity, order=T, levels = c('I1', 'SI2', 'SI1', 'VS2', 'VS1', 'VVS2', 'VVS1', 'IF'))
diamonds$cut = factor(diamonds$cut, order=T, levels = c('Fair', 'Good', 'Very Good', 'Premium', 'Ideal'))
colnames(diamonds)[1] = "ID"
colnames(diamonds)
summary(diamonds)
```

## EDA section - Adam (in progress)

### diamonds summary

```{r, results = 'markup'}
xkablesummary(diamonds, title = "Summary of Diamonds")
```


### Categorical Data Exploration

```{r categorical variables}
barplot(table(diamonds$cut), col = c(6, 7, 8, 3, 4), main = 'Barplot of Cut', xlab = "Cut", ylab = "Frequency")
barplot(table(diamonds$color), col = c(2, 3, 4, 7, 6, 8, 9), main = 'Barplot of Color', xlab = "Color", ylab = "Frequency")
barplot(table(diamonds$clarity), col = c(2, 3, 4, 7, 6, 8, 9, 5), main = 'Barplot of Clarity', xlab = "Clarity", ylab = "Frequency")

cut_count = dplyr::count(diamonds, cut)
colnames(cut_count)[colnames(cut_count) == 'cut'] <- 'Cut'
cut_count$n = cut_count$n/sum(cut_count$n)

loadPkg("ggplot2")

ggplot(cut_count, aes(x = "", y = n, fill = Cut)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  geom_text(size = 4, aes(label = paste0(round(n, 2), "%")), position = position_stack(vjust = 0.5))+
  scale_fill_manual(values = c(6, 7, 8, 3, 4))+
  labs(title='Pie Chart of Cut')
  
```

### diamonds numerical text summaries

```{r numerical variables text}
mean(diamonds$depth)
sd(diamonds$depth)

mean(diamonds$table)
sd(diamonds$table)

mean(diamonds$carat)
sd(diamonds$carat)

mean(diamonds$price)
sd(diamonds$price)
```

### Numerical Data Exploration

```{r numerical variables}
# removed weird outliers, note in slides
diaNO = subset(diamonds, x > 0 & y > 0 & z > 0 & y <30 & z <30)
ggplot(diaNO, aes(x, y, color=z)) +
  geom_point(size = 8, alpha = 0.6) +
  ggtitle('Y versus X versus Z for Diamonds') +
  scale_color_gradient2(midpoint = 5, low="blue", mid="green", high="red")

ggplot(diamonds, aes(y=table)) + 
  geom_histogram(col="black", 
                 fill="green", 
                  alpha = .8,
                 binwidth = 1.5) +
  labs(title='Histogram of Table') +
  coord_flip() +
  labs(y="Table", x="Frequency")

ggplot(diamonds, aes(y=depth)) + 
  geom_histogram(col="black", 
                 fill="red", 
                  alpha = .8,
                 binwidth = 1) +
  coord_flip() +
  labs(title='Histogram of Depth') +
  labs(y="Depth", x="Frequency")

ggplot(diamonds, aes(y=carat)) + 
  geom_boxplot() + 
  geom_boxplot(colour="black", fill="orange", outlier.colour="orange", outlier.size=5, alpha = 0.8) +
  labs(title = 'Boxplot of Carat')+
  labs(y="Carat")
```

### Price Exploration

```{r d10kp price}
ggplot(diamonds, aes(y=price)) + 
  geom_boxplot() + 
  geom_boxplot(colour="black", fill="blue", outlier.colour="blue", outlier.size=5, alpha = 0.8) +
  labs(title = 'Boxplot of Price')

ggplot(diamonds, aes(y=price)) + 
  geom_histogram(col="black", 
                 fill="blue", 
                  alpha = .8,
                 binwidth = 300) +
  coord_flip() +
  labs(title='Histogram of Price') +
  labs(y="Price", x="Frequency")

qqnorm(diamonds$price, main="Q-Q plot of Price", col = 'blue', ylab = 'Price') 
qqline(diamonds$price)

```

## caterigocal affect on price - Solomon


### **Diamond CUT**

The Diamonds data set have five `cut` types with the  highest superscript indicating the best: 

   Fair^1^ | Good^2^ | Very Good^3^ | Premium^4^ | Ideal^5^
   
```{r, results='hide'}

diamonds_outliers_removed<- outlierKD2(diamonds,price, TRUE,FALSE, FALSE, FALSE)
```


```{r,results='markup'}
# any(is.na.data.frame(diamonds)) colSums(is.na(diamonds))
cut <- subset(diamonds,select=c(cut))
xkabledply(table(cut),title = "Distinct Count of Cut Type",wide=TRUE)
barplot(table(cut),main = "Bar Plot on Diamonds Cut Type",xlab = "Cut",ylab = "Cut_frequency", col=rainbow(5))

```

It is noticed from the bar plot that most of the customers went for the `Ideal` Diamond cut which is `100%` from the cut scale (20% for each level of cut grade). 

```{r,results = "markup"}
ggplot(diamonds,aes(x=cut,y=price,fill=cut))+geom_boxplot()+theme_light()+ggtitle("Box Plot on Diamonds Cut")


ggplot(diamonds_outliers_removed,aes(x=cut,y=price,fill=cut))+geom_boxplot()+theme_light()+ggtitle("Box Plot on Diamonds Cut (Outliers Minimized)")


caov <- aov(diamonds_outliers_removed$price~cut,data = diamonds_outliers_removed)
```

It can be noticed from the box plot that the mean of Ideal cut is different from other mean cuts.


### **ANOVA of Price and Cut**

H~0~ :There is no difference in the mean price across different diamonds cut

H~1~ :There is difference in the mean price across different diamonds cut

```{r cutaov,results = "markup"}
xkabledply(caov, title = "ANOVA Modelling of Price by Cut")
```

We reject H~0~ from the ANOVA test between Diamonds price and cut with p-value `2E-16` as this shows that the mean price across different diamonds cut are different.

```{r, results='markup'}
TukeyCutAoV <- TukeyHSD(caov)
TukeyCutAoV

```


```{r,results='markup'}
model.tables(caov,"mean")
```

We proceed to a post-hoc (Tukey HSD) test to uncover specific differences between the cut group means.

Our result shows that the pairs:
Good-Fair | Very Good-Fair | Ideal-Fair | Premium-Good | Ideal-Good | Premium-Very Good | Ideal-Very Good | Ideal-Premium are significant with a p-value less than 0.05.

We can also infer that it is very likely (significant) for customers to purchase diamonds with `fair`, `Good`, `Very Good`, `Premium` cut than `Ideal` cut type.

### **Diamond COLOR**

The Diamonds data set have seven `color` grades with the  highest superscript indicating the best: 
  
  D^1^ | E^2^ | F^3^ | G^4^ | H^5^ | I^6^ | J^7^

```{r,results='markup'}
color<- subset(diamonds,select = c(color))
xkabledply((table(color)),title = "Distinct Count of Diamond's Color Grade",wide=TRUE)
barplot(table(color),main = "Bar Plot on Diamonds Color Grade",xlab = "Color (grade)",ylab = "Color_frequency", col=rainbow(7))
```

It is noticed from the bar plot that most of the customers went for the `G` Diamond color grade which is about `57.14%`  from the clarity scale (~14.286% for each level of color grade). 


```{r, results='markup'}
ggplot(diamonds,aes(x=color,y=price,fill=color))+geom_boxplot()+theme_light()+ggtitle("Box Plot on Diamonds Color")

ggplot(diamonds_outliers_removed,aes(x=color,y=price,fill=color))+geom_boxplot()+theme_light()+ggtitle("Box Plot on Diamonds Color (Outliers Minimized)")
```

It is noticed from the boxplot that the means of color type `F` to `J` are higher than color type `D, E`.

### **ANOVA of Price and Color**

H~0~ :There is no difference in the mean price across different diamonds color grade

H~1~ :There is difference in the mean price across different diamonds color grade

```{r,results='markup'}
caov2<- aov(diamonds_outliers_removed$price~color, data=diamonds_outliers_removed)
xkabledply(caov2, title = "ANOVA Modelling of Price by Color")
```

Also, we reject H~0~ the ANOVA test between Diamonds price and color with p-value `2E-16` as this shows that the mean price across different diamonds colors are different.

```{r, results='markup'}
TukeyColorAoV <- TukeyHSD(caov2)
TukeyColorAoV
model.tables(caov2,"mean")

```

From the grand means it shows that people are likely to spend more on poor colored type diamonds.

The Tukey post-hoc test for color grade groups, shows that the pairs are significant with p-value less than 0.05 except for `E-D` pair.


### **Diamond CLARITY**

The Diamonds data set have eight `clarity` grades with the  highest superscript indicating the best: 
 
  I1^1^ | SI2^2^ | SI1^3^ | VS2^4^ | VS1^5^ | VVS2^6^ | VVS1^7^ | IF^8^

```{r, results='markup'}
clarity<- subset(diamonds,select = c(clarity))
xkabledply((table(clarity)),title = "Distinct Count of Diamond's clarity",wide=TRUE)
barplot(table(clarity),main = "Bar Plot on Diamond's clarity",xlab = "clarity (grade)",ylab = "Clarity_frequency", col=rainbow(7))
```


It is noticed from the bar plot that most of the customers went for the `SI1` Diamond clarity type which is about `37.5%` clear from the clarity scale (12.5% for each level of clarity). 


```{r,results='markup'}

ggplot(diamonds,aes(x=clarity,y=price,fill=clarity))+geom_boxplot()+theme_light()+ggtitle("Box Plot on Diamond's Clarity")

ggplot(diamonds_outliers_removed,aes(x=clarity,y=price,fill=clarity))+geom_boxplot()+theme_light()+ggtitle("Box Plot on Diamonds Clarity (Outliers Minimized)")
```

The boxplot above shows a very distinct variation with the mean of `SI2, I1, SI1` diamond clarity types.

### **ANOVA of Price and Clarity**

H~0~ :There is no difference in the mean price across different diamonds clarity

H~1~ :There is difference in the mean price across different diamonds clarity

```{r, results='markup'}
caov3<- aov(diamonds_outliers_removed$price~clarity, data=diamonds_outliers_removed)
xkabledply(caov3, title = "ANOVA Modelling of Price by Clarity")
```

We reject H~0~ from the ANOVA test between Diamonds price and clarity with p-value `2E-16` as this shows that the mean price across different diamonds clarity are different.


```{r, results='markup'}
TukeyClarityAoV <- TukeyHSD(caov3)
TukeyClarityAoV
model.tables(caov3,"mean")

```

The grand means also made it clear that it is more likely for customers to spend more on lower/poorer clarity diamonds.

The post-hoc test made it clear that aside from these pairs SI2-I1, VS1-VS2, IF-VVS1 which are not significant; all other pairs are significantly different with p-value less than 0.05.


## continious variable affect on price - Suhas

```{r, results='markup'}
# T.test for continuous variables

diamonds_carat1 = subset(diamonds, carat < 1)
diamonds_carat2 = subset(diamonds, carat >= 1)

#two- sample ttest

t.test(diamonds_carat1$price, diamonds_carat2$price)

#for depth

diamonds_depth1 = subset(diamonds, depth < 61.7)
diamonds_depth2 = subset(diamonds, depth > 61.8)

#two- sample ttest

t.test(diamonds_depth1$price, diamonds_depth2$price)

#for table 

diamonds_table1 = subset(diamonds, table < 57.5)
diamonds_table2 = subset(diamonds, table > 57.5)

#two- sample ttest

t.test(diamonds_table1$price, diamonds_table2$price)


#for x


diamonds_x1 = subset(diamonds, x < 5.73)
diamonds_x2 = subset(diamonds, x > 5.73)

#two- sample ttest

t.test(diamonds_x1$price, diamonds_x2$price)

#for y


diamonds_y1 = subset(diamonds, y < 5.7)
diamonds_y2 = subset(diamonds, y > 5.7)

#two- sample ttest

t.test(diamonds_y1$price, diamonds_y2$price)

#for z

diamonds_z1 = subset(diamonds, z < 3.5)
diamonds_z2 = subset(diamonds, z > 3.5)

#two- sample ttest

t.test(diamonds_z1$price, diamonds_z2$price)

```
From the t-tests above we can see that there is a significant difference in average price of diamond when we split the samples at the mean for variables such as carat, x, y, z and table. There is almost no difference in mean observed when we perform the two sample t-test for depth. From these tests we can get a sense of the correlations between price and other variables. Let us calculate the correlation matrix and plot a corrplot to see these relationships.


```{r, results= 'markup'}
# Creating a subset of continuous variables, calculating the correlation matrix and making the corrplot to identify the strongest relationships between continuous variables.

diamonds_continuous = subset(diamonds, select = c("carat", "depth", "table", "price", "x", "y", "z"))
loadPkg("corrplot")
diamonds_continuous_cor= cor(diamonds_continuous)
corrplot(diamonds_continuous_cor, method= "number")
library(ggplot2)
library(car)
```

From the correlation matrix and corrplot we can see which variables have the strongest relationship with price of the diamond. We can see that carat and price have a very strong positive relationship followed by x, y, z and then table. 

Let us build some linear models to explain the variation in price with respect to other variables.

```{r, results='markup'}
fit1 <- lm(price ~ carat, data = diamonds)
summary(fit1)

xkabledply(fit1, title = paste("Model :", format(formula(fit1)) ) )

avplots(fit1)
avPlots(fit1)
```

```{r, results='markup'}
@ -503,80 +503,80 @@

```

Comparing the different linear models built, we can see that variation in carat best explains the variation in price. Addition of more variables to that linear model only explains the variation in price slightly better and from the Anova test result, we can see that F statistic values is highest for the fit 2 and lower for all other models. By this we can reject all the models but fit2, since it explains the variation in price best as compared to other models.
Comparing the different linear models built, we can see that variation in carat best explains the variation in price. Addition of more variables to that linear model only explains the variation in price slightly better but those variables demonstrate multi-collinearity and using those variables would be redundant. By this we can reject all the models but fit1, since it explains the variation in price best as compared to other models.

## What affects the cutting methods?- Huang  
  
After exploring what affects the price of diamonds, we are very interested in the cutting method of the diamonds. As we all know, considering that the better the cutting method, the higher the cost, it seems that the higher the quality of the raw material, the more likely it is to adopt the perfect cutting method.  
In this dataset, Clarity and color can represent the quality of the raw material.  

### SMART Question: Do different ranks of clarity have different cutting methods?  
Below is the statistics table of clarity and cutting method. All kinds of cutting methods are adopted in all ranks of clarity. But the percentage of each cutting methods may be different in different ranks of clarity.   
```{r results='markup'}
tab_cut_cla = table(diamonds$clarity,diamonds$cut)
xkabledply(tab_cut_cla,title = "Statistics Table of Clarity VS Cut")
```
  
So, we draw pie charts of each rank of clarity. As the below charts shows, the worst rank of clarity (I1) uses the worst cutting method (fair) the most, but the best rank of clarity (IF) uses the best cutting method (ideal) the most.  

```{r}
names = colnames(tab_cut_cla)
cols = c("#ED1C24","#22B14C","#FFC90E","#3f48CC","pink")
piepercent_1 = paste(names,":",round(100*tab_cut_cla[1,]/sum(tab_cut_cla[1,])), "%")
piepercent_2 = paste(names,":",round(100*tab_cut_cla[2,]/sum(tab_cut_cla[2,])), "%")
piepercent_3 = paste(names,":",round(100*tab_cut_cla[3,]/sum(tab_cut_cla[3,])), "%")
piepercent_4 = paste(names,":",round(100*tab_cut_cla[4,]/sum(tab_cut_cla[4,])), "%")
piepercent_5 = paste(names,":",round(100*tab_cut_cla[5,]/sum(tab_cut_cla[5,])), "%")
piepercent_6 = paste(names,":",round(100*tab_cut_cla[6,]/sum(tab_cut_cla[6,])), "%")
piepercent_7 = paste(names,":",round(100*tab_cut_cla[7,]/sum(tab_cut_cla[7,])), "%")
piepercent_8 = paste(names,":",round(100*tab_cut_cla[8,]/sum(tab_cut_cla[8,])), "%")
par(mfrow=c(2,2))
pie(tab_cut_cla[1,], labels=piepercent_1, main = "I1 rank of clarity", col=cols)
pie(tab_cut_cla[2,], labels=piepercent_2, main = "SI2 rank of clarity", col=cols)
pie(tab_cut_cla[3,], labels=piepercent_3, main = "SI1 rank of clarity", col=cols)
pie(tab_cut_cla[4,], labels=piepercent_4, main = "VS2 rank of clarity", col=cols)
pie(tab_cut_cla[5,], labels=piepercent_5, main = "VS1 rank of clarity", col=cols)
pie(tab_cut_cla[6,], labels=piepercent_6, main = "VVS2 rank of clarity", col=cols)
pie(tab_cut_cla[7,], labels=piepercent_7, main = "VVS1 rank of clarity", col=cols)
pie(tab_cut_cla[8,], labels=piepercent_8, main = "IF rank of clarity", col=cols)
```
   
Or we can turn the pie charts to one bar chart.  
```{r}
loadPkg("ggstatsplot")
p = ggbarstats(data = diamonds, x = cut, y = clarity,results.subtitle = F,palette = "Set3", bar.proptest= F)
p
```
  
This bar chart shows the percentages of each cutting methods in each rank of clarity. It is clear that, with the rise of clarity ranks (from I1 to IF), the percentage of ideal cutting methods continues to increase and the percentage of fair cutting methods keeps decreasing.  
It seems that good ranks of clarity use good cutting methods.  
In order to obtain evidence to support our conclusion, we performed a Chi-squared test. The result is below. Because the p-value is too small, we have enough evidence to conclude that clarity of diamonds does affect the cutting methods.  
```{r results='markup'}
chitest_cut_cla = chisq.test(tab_cut_cla)
chitest_cut_cla
```
  
### SMART Question: Do different ranks of color have different cutting methods?  

Below is the statistics table of color and cutting methods. All kinds of cutting methods are adopted in all ranks of color. But the percentage of each cutting methods may be different in different ranks of color.    
```{r}
tab_cut_col = table(diamonds$color,diamonds$cut)
xkabledply(tab_cut_col,title = "Statistics Table of Color VS Cut")
```
  
So, we draw pie charts of each rank of clarity. As the below charts shows, the percentages of each cutting methods are different in different ranks of color. Rank D is the best rank of color and rank J is the worst. Higher ranks of colors uses higher percentage of premium and ideal cutting methods.  

```{r}
names = colnames(tab_cut_col)
cols = c("#ED1C24","#22B14C","#FFC90E","#3f48CC","pink")
piepercent_d = paste(names,":",round(100*tab_cut_col[1,]/sum(tab_cut_col[1,])), "%")
piepercent_e = paste(names,":",round(100*tab_cut_col[2,]/sum(tab_cut_col[2,])), "%")
piepercent_f = paste(names,":",round(100*tab_cut_col[3,]/sum(tab_cut_col[3,])), "%")
piepercent_g = paste(names,":",round(100*tab_cut_col[4,]/sum(tab_cut_col[4,])), "%")
piepercent_h = paste(names,":",round(100*tab_cut_col[5,]/sum(tab_cut_col[5,])), "%")
piepercent_i = paste(names,":",round(100*tab_cut_col[6,]/sum(tab_cut_col[6,])), "%")
piepercent_j = paste(names,":",round(100*tab_cut_col[7,]/sum(tab_cut_col[7,])), "%")
par(mfrow=c(2,2))
pie(tab_cut_col[1,], labels=piepercent_d, main = "D rank of color", col=cols)
pie(tab_cut_col[2,], labels=piepercent_e, main = "E rank of color", col=cols)
pie(tab_cut_col[3,], labels=piepercent_f, main = "F rank of color", col=cols)
pie(tab_cut_col[4,], labels=piepercent_g, main = "G rank of color", col=cols)
pie(tab_cut_col[5,], labels=piepercent_h, main = "H rank of color", col=cols)
pie(tab_cut_col[6,], labels=piepercent_i, main = "I rank of color", col=cols)
pie(tab_cut_col[7,], labels=piepercent_j, main = "J rank of color", col=cols)
```
  
Also, we can turn the pie charts to one bar chart to compare the difference.  
```{r}
p = ggbarstats(data = diamonds, x = cut, y = color,results.subtitle = F,palette = "Set3", bar.proptest= F)
p
```
  
On the whole, In general, as the rank of color decreases (from D to J), the proportion of using better cutting methods is also decreasing.  
It seems that the higher ranks of color use greater cutting methods more. 
In order to obtain evidence to support our conclusion, we performed a Chi-squared test. The result is below. Because the p-value is too small, we have enough evidence to conclude that color of diamonds does affect the cutting methods.  
```{r results='markup'}
chitest_cut_col = chisq.test(tab_cut_col)
chitest_cut_col
```